<!--pages/customerDetail/customerDetail.wxml-->
<view class="container">
  <!-- 顶部客户信息 -->
  <view class="customer-header" wx:if="{{customer}}">
    <view class="customer-basic">
      <view class="customer-name">{{customer.name}}</view>
      <view class="customer-meta">
        <text class="store-name">{{customer.store_name}}</text>
        <text class="phone">{{customer.phone}}</text>
      </view>
    </view>
    <view class="weight-overview">
      <view class="weight-item">
        <text class="weight-label">初始体重</text>
        <text class="weight-value">{{customer.initial_weight || '-'}} kg</text>
      </view>
      <view class="weight-item">
        <text class="weight-label">当前体重</text>
        <text class="weight-value">{{customer.current_weight || '-'}} kg</text>
      </view>
      <view class="weight-item">
        <text class="weight-label">目标体重</text>
        <text class="weight-value">{{customer.target_weight || '-'}} kg</text>
      </view>
    </view>
    <view class="progress-section">
      <view class="progress-header">
        <text class="progress-label">减肥进度</text>
        <text class="progress-percentage">{{customer.progress || 0}}%</text>
      </view>
      <view class="progress-bar-container">
        <view class="progress-bar" style="width: {{customer.progress || 0}}%"></view>
      </view>
      <view class="weight-lost-info">
        <text>已减重: {{customer.lost_weight || 0}} kg</text>
        <text>还需减重: {{customer.needs_to_lose || 0}} kg</text>
      </view>
    </view>
  </view>
  
  <!-- 功能选项卡 -->
  <view class="tabs">
    <view class="tab {{activeTab === 'info' ? 'active' : ''}}" bindtap="switchTab" data-tab="info">
      <text>基本信息</text>
    </view>
    <view class="tab {{activeTab === 'record' ? 'active' : ''}}" bindtap="switchTab" data-tab="record">
      <text>体重记录</text>
    </view>
    <view class="tab {{activeTab === 'product' ? 'active' : ''}}" bindtap="switchTab" data-tab="product">
      <text>产品使用</text>
    </view>
  </view>
  
  <!-- 内容区 -->
  <view class="content-area">
    <!-- 基本信息 -->
    <view class="content-section" wx:if="{{activeTab === 'info' && customer}}">
      <view class="info-group">
        <view class="info-item">
          <text class="info-label">年龄</text>
          <text class="info-value">{{customer.age || '-'}} 岁</text>
        </view>
        <view class="info-item">
          <text class="info-label">身高</text>
          <text class="info-value">{{customer.height || '-'}} cm</text>
        </view>
        <view class="info-item">
          <text class="info-label">性别</text>
          <text class="info-value">{{customer.gender === 1 ? '男' : (customer.gender === 2 ? '女' : '-')}}</text>
        </view>
      </view>
      
      <view class="bmi-section" wx:if="{{currentBmi && customer.height}}">
        <view class="bmi-header">
          <text class="bmi-title">身体质量指数(BMI)</text>
          <text class="bmi-value">{{currentBmi}}</text>
        </view>
        
        <view class="bmi-category" style="color: {{bmiCategory.color}}">
          {{bmiCategory.label}}
        </view>
        
        <view class="bmi-scale">
          <view class="bmi-range" wx:for="{{bmiCategories}}" wx:key="label"
                style="flex: {{item.max - item.min}}; background-color: {{item.color}};">
            <text class="bmi-range-label" wx:if="{{item.max - item.min > 3}}">{{item.label}}</text>
          </view>
        </view>
        <view class="bmi-marker" style="left: {{(currentBmi > 40 ? 40 : (currentBmi < 15 ? 15 : currentBmi)) - 15}}%"></view>
        
        <view class="bmi-info">
          <text class="bmi-info-text">BMI = 体重(kg) / 身高²(m)</text>
          <text class="bmi-info-text">正常范围: 18.5 - 24</text>
        </view>
      </view>
      
      <view class="info-item notes">
        <text class="info-label">备注</text>
        <text class="info-value">{{customer.notes || '无'}}</text>
      </view>
      
      <view class="action-buttons">
        <button class="action-btn edit" bindtap="editCustomer">编辑信息</button>
        <button class="action-btn export" bindtap="showExportOptions">导出报表</button>
      </view>
    </view>
    
    <!-- 体重记录 -->
    <view class="content-section" wx:if="{{activeTab === 'record'}}">
      <!-- 体重趋势图 -->
      <view class="chart-container" wx:if="{{weightRecords.length > 0}}">
        <view class="chart-header">
          <view class="chart-title">体重变化趋势</view>
          <view class="chart-actions" wx:if="{{customer.height && chartData.series.length > 1}}">
            <view class="chart-toggle" bindtap="toggleBmi">
              <text>显示BMI</text>
              <switch checked="{{showBmi}}" color="#4CAF50" />
            </view>
          </view>
        </view>
        <view class="chart-area">
          <canvas class="weight-chart" canvas-id="weightChart"></canvas>
        </view>
        <view class="chart-legend">
          <view class="legend-item">
            <view class="legend-color" style="background-color: #1aad19"></view>
            <text class="legend-text">体重(kg)</text>
          </view>
          <view class="legend-item" wx:if="{{customer.height && showBmi}}">
            <view class="legend-color" style="background-color: #f56c6c"></view>
            <text class="legend-text">BMI</text>
          </view>
        </view>
      </view>
      
      <!-- 体重记录列表 -->
      <view class="record-list">
        <view class="record-header">
          <text class="record-date-header">日期</text>
          <text class="record-weight-header">体重(kg)</text>
          <text class="record-change-header">变化</text>
          <text class="record-action-header"></text>
        </view>
        
        <block wx:if="{{weightRecords.length > 0}}">
          <view class="record-item" wx:for="{{weightRecords}}" wx:key="id">
            <text class="record-date">{{item.record_date}}</text>
            <text class="record-weight">{{item.weight}}
              <text class="record-percent" wx:if="{{item.lossPercentage && item.lossPercentage != '0.0'}}">
                ({{item.lossPercentage}}%)
              </text>
            </text>
            <text class="record-change {{item.change < 0 ? 'positive' : (item.change > 0 ? 'negative' : '')}}">
              {{item.change < 0 ? '' : (item.change > 0 ? '+' : '')}}{{item.change || 0}}
            </text>
            <view class="record-actions">
              <view class="record-delete" catchtap="deleteWeightRecord" data-id="{{item.id}}" wx:if="{{item.id !== 'initial' && item.id !== 'current'}}">删除</view>
            </view>
          </view>
        </block>
        <view wx:else class="empty-tip">
          <text>暂无体重记录</text>
        </view>
      </view>
      
      <view class="action-buttons">
        <button class="action-btn add" bindtap="addWeightRecord">添加记录</button>
      </view>
    </view>
    
    <!-- 产品使用 -->
    <view class="content-section" wx:if="{{activeTab === 'product'}}">
      <view class="product-list">
        <view class="product-header">
          <text class="product-name-header">产品名称</text>
          <text class="product-date-header">使用日期</text>
          <text class="product-count-header">剩余次数</text>
        </view>
        
        <block wx:if="{{productUsageList.length > 0}}">
          <view class="product-item" wx:for="{{productUsageList}}" wx:key="id">
            <text class="product-name">{{item.product_name}}</text>
            <text class="product-date">{{item.usage_date}}</text>
            <text class="product-count">{{item.remaining_count || 0}}次</text>
          </view>
        </block>
        <view wx:else class="empty-tip">
          <text>暂无产品使用记录</text>
        </view>
      </view>
      
      <view class="action-buttons">
        <button class="action-btn add" bindtap="addProductUsage">添加记录</button>
      </view>
    </view>
  </view>
  
  <!-- 导出报表选项 -->
  <view class="export-options-mask" wx:if="{{showExportOptions}}" bindtap="hideExportOptions">
    <view class="export-options-container" catchtap="stopPropagation">
      <view class="export-options-header">
        <text class="export-options-title">导出减肥报表</text>
        <view class="export-options-close" bindtap="hideExportOptions">×</view>
      </view>
      
      <view class="export-options-content">
        <view class="export-option-group">
          <text class="export-option-label">报表格式</text>
          <view class="export-option-buttons">
            <view class="export-option-btn {{reportType === 'pdf' ? 'active' : ''}}" bindtap="selectReportType" data-type="pdf">
              PDF
            </view>
            <view class="export-option-btn {{reportType === 'excel' ? 'active' : ''}}" bindtap="selectReportType" data-type="excel">
              Excel
            </view>
            <view class="export-option-btn {{reportType === 'word' ? 'active' : ''}}" bindtap="selectReportType" data-type="word">
              Word
            </view>
          </view>
        </view>
        
        <view class="export-option-group">
          <text class="export-option-label">日期范围</text>
          <view class="export-option-buttons">
            <view class="export-option-btn {{dateRange === '30' ? 'active' : ''}}" bindtap="selectDateRange" data-range="30">
              近30天
            </view>
            <view class="export-option-btn {{dateRange === '90' ? 'active' : ''}}" bindtap="selectDateRange" data-range="90">
              近3个月
            </view>
            <view class="export-option-btn {{dateRange === 'all' ? 'active' : ''}}" bindtap="selectDateRange" data-range="all">
              全部
            </view>
          </view>
        </view>
      </view>
      
      <view class="export-options-footer">
        <button class="export-cancel-btn" bindtap="hideExportOptions">取消</button>
        <button class="export-confirm-btn" bindtap="exportWeightReport">导出</button>
      </view>
    </view>
  </view>
  
  <!-- 加载中 -->
  <view class="loading-mask" wx:if="{{isLoading || isExporting}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{isExporting ? '生成报表中...' : '加载中...'}}</text>
  </view>
</view> 