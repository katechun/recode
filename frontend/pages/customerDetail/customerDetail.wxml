<!--pages/customerDetail/customerDetail.wxml-->
<view class="container">
  <!-- é‡æ„çš„é¡¶éƒ¨å®¢æˆ·ä¿¡æ¯ -->
  <view class="customer-header" wx:if="{{customer}}">
    <!-- åå­—å’ŒID -->
    <view class="header-top">
      <view class="customer-name-id">
        <text class="customer-name">{{customer.name}}</text>
        <text class="customer-id">5555</text>
      </view>
    </view>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="customer-profile">
      <view class="profile-row">
        <view class="profile-item">
          <text class="profile-label">å¹´é¾„</text>
          <text class="profile-value">{{customer.age || '-'}} å²</text>
        </view>
        <view class="profile-item">
          <text class="profile-label">èº«é«˜</text>
          <text class="profile-value">{{customer.height || '-'}} cm</text>
        </view>
      </view>
      <view class="profile-row">
        <view class="profile-item">
          <text class="profile-label">æ€§åˆ«</text>
          <text class="profile-value">{{customer.gender === 1 ? 'ç”·' : (customer.gender === 2 ? 'å¥³' : '-')}}</text>
        </view>
        <view class="profile-item">
          <text class="profile-label">åˆ†åº—</text>
          <text class="profile-value">{{customer.store_name || '-'}}</text>
        </view>
      </view>
      <!-- å‡è‚¥æƒ…å†µï¼ˆæ‰ç§¤é‡å’Œä»£è°¢é‡ï¼‰ - ä½œä¸ºprofileçš„ç¬¬ä¸‰è¡Œ -->
      <view class="profile-row weight-data-row">
        <view class="profile-item weight-data-item">
          <text class="profile-label">æ‰ç§¤é‡</text>
          <view class="weight-data-content">
            <text class="profile-value weight-data-value">{{weightDropValue || '0.0'}} kg</text>
            <text class="weight-data-hint">ä»Šæ—¥æ—©ç§°</text>
          </view>
        </view>
        <view class="profile-item weight-data-item">
          <text class="profile-label">ä»£è°¢é‡</text>
          <view class="weight-data-content">
            <text class="profile-value weight-data-value">{{metabolismValue || '0.0'}} kg</text>
            <text class="weight-data-hint">ä»Šæ—¥æ™šç§°</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- é¡¾å®¢ç”µè¯ä¿¡æ¯ -->
    <view class="customer-meta">
      <view class="phone">{{customer.phone || 'æš‚æ— ç”µè¯'}}</view>
    </view>
    
    <!-- æ·»åŠ å‘¨è¶‹åŠ¿å›¾åŒºåŸŸ -->
    <view class="weekly-weight-trend">
      <text class="weekly-trend-title">æœ¬å‘¨æ‰ç§¤è¶‹åŠ¿</text>
      <view class="weekly-trend-chart">
        <view class="trend-day" wx:for="{{weeklyWeightTrend}}" wx:key="date">
          <view class="trend-bar {{item.value < 0 ? 'negative' : ''}}" style="height: {{item.height}}rpx;"></view>
          <text class="trend-value">{{item.value}}kg</text>
          <text class="trend-date">{{item.date}}</text>
        </view>
      </view>
    </view>
    
    <!-- ä½“é‡ä¿¡æ¯ - ç›´æ¥ç´§æ¥åœ¨å‡è‚¥æƒ…å†µåé¢ -->
    <view class="weight-overview" style="margin-top:0 !important; padding-top:0 !important;">
      <view class="weight-item">
        <text class="weight-label">åˆå§‹ä½“é‡</text>
        <text class="weight-value">{{customer.initial_weight || '-'}} kg</text>
      </view>
      <view class="weight-item">
        <text class="weight-label">å½“å‰ä½“é‡</text>
        <text class="weight-value">{{customer.current_weight || '-'}} kg</text>
      </view>
      <view class="weight-item">
        <text class="weight-label">ç›®æ ‡ä½“é‡</text>
        <text class="weight-value">{{customer.target_weight || '-'}} kg</text>
      </view>
    </view>
    
    <!-- å‡è‚¥è¿›åº¦ -->
    <view class="progress-section">
      <view class="progress-header">
        <text class="progress-label">å‡è‚¥è¿›åº¦</text>
        <text class="progress-percentage">{{customer.progress || 0}}%</text>
      </view>
      <view class="progress-bar-container">
        <view class="progress-bar" style="width: {{customer.progress || 0}}%"></view>
      </view>
      <view class="weight-lost-info">
        <text>å·²å‡é‡: {{customer.lost_weight || 0}} kg</text>
        <text>è¿˜éœ€å‡é‡: {{customer.needs_to_lose || 0}} kg</text>
      </view>
      <view class="goal-achieved" wx:if="{{customer.progress >= 100}}">
        <text class="goal-icon">ğŸ¯</text>
        <text>æ­å–œæ‚¨å·²è¾¾æˆå‡é‡ç›®æ ‡ï¼</text>
      </view>
    </view>
  </view>
  
  <!-- åŠŸèƒ½é€‰é¡¹å¡ -->
  <view class="tabs">
    <view class="tab {{activeTab === 'info' ? 'active' : ''}}" bindtap="switchTab" data-tab="info">
      <text>åŸºæœ¬ä¿¡æ¯</text>
    </view>
    <view class="tab {{activeTab === 'record' ? 'active' : ''}}" bindtap="switchTab" data-tab="record">
      <text>ä½“é‡è®°å½•</text>
    </view>
    <view class="tab {{activeTab === 'product' ? 'active' : ''}}" bindtap="switchTab" data-tab="product">
      <text>äº§å“ä½¿ç”¨</text>
    </view>
  </view>
  
  <!-- å†…å®¹åŒº -->
  <view class="content-area">
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="content-section" wx:if="{{activeTab === 'info' && customer}}">
      <view class="bmi-section" wx:if="{{currentBmi && customer.height}}">
        <view class="bmi-header">
          <text class="bmi-title">èº«ä½“è´¨é‡æŒ‡æ•°(BMI)</text>
          <text class="bmi-value">{{currentBmi}}</text>
        </view>
        
        <view class="bmi-category" style="color: {{bmiCategory.color}}">
          {{bmiCategory.label}}
        </view>
        
        <view class="bmi-scale">
          <view class="bmi-range" wx:for="{{bmiCategories}}" wx:key="label"
                style="flex: {{item.max - item.min}}; background-color: {{item.color}};">
            <text class="bmi-range-label" wx:if="{{item.max - item.min > 3}}">{{item.label}}</text>
          </view>
        </view>
        <view class="bmi-marker" style="left: {{(currentBmi > 40 ? 40 : (currentBmi < 15 ? 15 : currentBmi)) - 15}}%"></view>
        
        <view class="bmi-info">
          <text class="bmi-info-text">BMI = ä½“é‡(kg) / èº«é«˜Â²(m)</text>
          <text class="bmi-info-text">æ­£å¸¸èŒƒå›´: 18.5 - 24</text>
        </view>

        <view class="bmi-advice">
          <text class="bmi-advice-title">å¥åº·æŒ‡å¯¼å»ºè®®</text>
          <text class="bmi-advice-content" wx:if="{{currentBmi < 18.5}}">
            æ‚¨çš„ä½“é‡åç˜¦ï¼Œå»ºè®®é€‚å½“å¢åŠ è¥å…»æ‘„å…¥ï¼Œå¢åŠ è‚Œè‚‰é”»ç‚¼ï¼Œæé«˜åŸºç¡€ä»£è°¢ç‡ã€‚
          </text>
          <text class="bmi-advice-content" wx:elif="{{currentBmi >= 18.5 && currentBmi < 24}}">
            æ‚¨çš„ä½“é‡åœ¨å¥åº·èŒƒå›´å†…ï¼Œå»ºè®®ä¿æŒå½“å‰é¥®é£Ÿä¹ æƒ¯å’Œè¿åŠ¨é¢‘ç‡ï¼Œç»´æŒå¥åº·ä½“é‡ã€‚
          </text>
          <text class="bmi-advice-content" wx:elif="{{currentBmi >= 24 && currentBmi < 28}}">
            æ‚¨çš„ä½“é‡è¶…æ ‡ï¼Œå»ºè®®æ§åˆ¶é¥®é£Ÿçƒ­é‡ï¼Œå¢åŠ è¿åŠ¨å¼ºåº¦ï¼Œæ¯å¤©ä¿æŒ30-60åˆ†é’Ÿä¸­ç­‰å¼ºåº¦æœ‰æ°§è¿åŠ¨ã€‚
          </text>
          <text class="bmi-advice-content" wx:elif="{{currentBmi >= 28}}">
            æ‚¨çš„ä½“é‡è¶…æ ‡è¾ƒå¤šï¼Œå»ºè®®åœ¨ä¸“ä¸šæŒ‡å¯¼ä¸‹åˆ¶å®šå‡é‡è®¡åˆ’ï¼Œé€æ­¥æ¢å¤å¥åº·ä½“é‡ï¼Œå®šæœŸç›‘æµ‹èº«ä½“çŠ¶å†µã€‚
          </text>
        </view>
      </view>
      
      <view class="body-fat-section" wx:if="{{bodyFatPercentage && bodyFatCategory}}">
        <view class="body-fat-header">
          <text class="body-fat-title">ä½“è„‚ç‡ä¼°ç®—</text>
          <text class="body-fat-value">{{bodyFatPercentage}}%</text>
        </view>
        
        <view class="body-fat-category" style="color: {{bodyFatCategory.color}}">
          {{bodyFatCategory.label}}
        </view>
        
        <view class="body-fat-scale">
          <view class="body-fat-range gender-{{customer.gender === 1 ? 'male' : 'female'}} range-low"></view>
          <view class="body-fat-range gender-{{customer.gender === 1 ? 'male' : 'female'}} range-normal"></view>
          <view class="body-fat-range gender-{{customer.gender === 1 ? 'male' : 'female'}} range-high"></view>
          <view class="body-fat-range gender-{{customer.gender === 1 ? 'male' : 'female'}} range-very-high"></view>
        </view>
        
        <view class="body-fat-marker" style="left: {{(customer.gender === 1 ? (bodyFatPercentage > 40 ? 40 : (bodyFatPercentage < 5 ? 5 : bodyFatPercentage)) : (bodyFatPercentage > 45 ? 45 : (bodyFatPercentage < 10 ? 10 : bodyFatPercentage))) - (customer.gender === 1 ? 5 : 10)}}%"></view>
        
        <view class="body-fat-info">
          <text class="body-fat-info-text">ä½“è„‚ç‡ = ä½“å†…è„‚è‚ªæ€»é‡/ä½“é‡Ã—100%</text>
          <text class="body-fat-info-text">å¥åº·èŒƒå›´: {{customer.gender === 1 ? '10%-20%ï¼ˆç”·æ€§ï¼‰' : '15%-25%ï¼ˆå¥³æ€§ï¼‰'}}</text>
        </view>
      </view>
      
      <view class="info-item notes">
        <text class="info-label">å¤‡æ³¨</text>
        <text class="info-value">{{customer.notes || 'æ— '}}</text>
      </view>
      
      <view class="action-buttons">
        <button class="action-btn edit" bindtap="editCustomer">ç¼–è¾‘ä¿¡æ¯</button>
        <button class="action-btn export" bindtap="showExportOptions">å¯¼å‡ºæŠ¥è¡¨</button>
      </view>
    </view>
    
    <!-- ä½“é‡è®°å½• -->
    <view class="content-section" wx:if="{{activeTab === 'record'}}">
      <!-- ä½“é‡è¶‹åŠ¿å›¾ -->
      <view class="chart-container" wx:if="{{weightRecords.length > 0}}">
        <view class="chart-header">
          <view class="chart-title">ä½“é‡å˜åŒ–è¶‹åŠ¿</view>
          <view class="chart-actions" wx:if="{{customer.height && chartData.series.length > 1}}">
            <view class="chart-toggle" bindtap="toggleBmi">
              <text>æ˜¾ç¤ºBMI</text>
              <switch checked="{{showBmi}}" color="#4CAF50" />
            </view>
          </view>
        </view>
        
        <view class="chart-area">
          <ec-canvas id="weightChart" canvas-id="weightChart" ec="{{ ec }}"></ec-canvas>
        </view>
        <view class="chart-legend">
          <view class="legend-item">
            <view class="legend-color" style="background-color: #1aad19"></view>
            <text class="legend-text">ä½“é‡(kg)</text>
          </view>
          <view class="legend-item" wx:if="{{customer.height && showBmi}}">
            <view class="legend-color" style="background-color: #f56c6c"></view>
            <text class="legend-text">BMI</text>
          </view>
        </view>
      </view>
      
      <!-- ä½“é‡è®°å½•åˆ—è¡¨ -->
      <view class="record-list">
        <view class="record-header">
          <text class="record-date-header">æ—¥æœŸ</text>
          <text class="record-weight-header">ä½“é‡(kg)</text>
          <text class="record-change-header">å˜åŒ–</text>
          <text class="record-action-header"></text>
        </view>
        
        <block wx:if="{{weightRecords && weightRecords.length > 0}}">
          <view class="weight-item" wx:for="{{weightRecords}}" wx:key="id">
            <view class="weight-date">
              <text class="date">{{item.record_date}}</text>
              <text class="time-type">{{item.time_type === 'morning' ? 'æ—©ç§°' : 'æ™šç§°'}}</text>
            </view>
            <view class="weight-value">
              <text class="value">{{item.weight}} kg</text>
              <view class="weight-change {{item.change > 0 ? 'weight-up' : (item.change < 0 ? 'weight-down' : 'weight-same')}}">
                {{item.change !== undefined ? (item.change > 0 ? '+' + item.change : item.change) : '0.0'}} kg
              </view>
            </view>
            <view class="weight-actions">
              <text class="weight-note" wx:if="{{item.notes}}">{{item.notes}}</text>
              <view class="weight-delete" wx:if="{{item.id !== 'initial' && item.id !== 'current'}}" data-id="{{item.id}}" bindtap="deleteWeightRecord">åˆ é™¤</view>
            </view>
          </view>
        </block>
        <view wx:else class="empty-tip">
          <text>æš‚æ— ä½“é‡è®°å½•</text>
          <view class="add-first-record" bindtap="addWeightRecord">ç‚¹å‡»æ·»åŠ ç¬¬ä¸€æ¡è®°å½•</view>
        </view>
      </view>
      
      <view class="action-buttons">
        <button class="action-btn add" bindtap="addWeightRecord">æ·»åŠ è®°å½•</button>
        <button class="action-btn analysis" bindtap="showWeightAnalysis" wx:if="{{weightRecords.length >= 2}}">å‡é‡æ•°æ®åˆ†æ</button>
      </view>
    </view>
    
    <!-- äº§å“ä½¿ç”¨ -->
    <view class="content-section" wx:if="{{activeTab === 'product'}}">
      <view class="product-list">
        <view class="product-header">
          <text class="product-name-header">åç§°</text>
          <text class="product-date-header">é¦–è´­</text>
          <text class="product-update-header">æ›´æ–°</text>
          <text class="product-purchase-header">æ¬¡æ•°</text>
          <text class="product-count-header">å‰©ä½™</text>
          <text class="product-action-header"></text>
        </view>
        
        <block wx:if="{{productUsageList && productUsageList.length > 0}}">
          <view class="product-item" wx:for="{{productUsageList}}" wx:key="id">
            <text class="product-name">{{item.product_name || 'æœªçŸ¥äº§å“'}}</text>
            <text class="product-date">{{item.usage_date || 'æœªçŸ¥æ—¥æœŸ'}}</text>
            <text class="product-update">{{item.update_date || '-'}}</text>
            <text class="product-purchase">{{item.purchase_count || 1}}æ¬¡</text>
            <view class="product-count-control">
              <view class="count-decrease" data-index="{{index}}" bindtap="decreaseProductCount">-</view>
              <text class="product-count">{{item.quantity || 0}}æ¬¡</text>
              <view class="count-increase" data-index="{{index}}" bindtap="increaseProductCount">+</view>
            </view>
            <view class="product-action">
              <view class="product-delete" data-id="{{item.id}}" data-index="{{index}}" bindtap="deleteProductUsage">
                <text class="delete-icon">Ã—</text>
              </view>
            </view>
          </view>
        </block>
        <view wx:else class="empty-tip">
          <text>{{isLoading ? 'åŠ è½½ä¸­...' : 'æš‚æ— äº§å“ä½¿ç”¨è®°å½•'}}</text>
        </view>
      </view>
      
      <view class="action-buttons">
        <button class="action-btn add" bindtap="addProductUsage">æ·»åŠ è®°å½•</button>
      </view>
    </view>
  </view>
  
  <!-- å¯¼å‡ºæŠ¥è¡¨é€‰é¡¹ -->
  <view class="export-options-mask" wx:if="{{showExportOptions}}" bindtap="hideExportOptions">
    <view class="export-options-container" catchtap="stopPropagation">
      <view class="export-options-header">
        <text class="export-options-title">å¯¼å‡ºå‡è‚¥æŠ¥è¡¨</text>
        <view class="export-options-close" bindtap="hideExportOptions">Ã—</view>
      </view>
      
      <view class="export-options-content">
        <view class="export-option-group">
          <text class="export-option-label">æŠ¥è¡¨æ ¼å¼</text>
          <view class="export-option-buttons">
            <view class="export-option-btn {{reportType === 'pdf' ? 'active' : ''}}" bindtap="selectReportType" data-type="pdf">
              PDF
            </view>
            <view class="export-option-btn {{reportType === 'excel' ? 'active' : ''}}" bindtap="selectReportType" data-type="excel">
              Excel
            </view>
            <view class="export-option-btn {{reportType === 'word' ? 'active' : ''}}" bindtap="selectReportType" data-type="word">
              Word
            </view>
          </view>
        </view>
        
        <view class="export-option-group">
          <text class="export-option-label">æ—¥æœŸèŒƒå›´</text>
          <view class="export-option-buttons">
            <view class="export-option-btn {{dateRange === '30' ? 'active' : ''}}" bindtap="selectDateRange" data-range="30">
              è¿‘30å¤©
            </view>
            <view class="export-option-btn {{dateRange === '90' ? 'active' : ''}}" bindtap="selectDateRange" data-range="90">
              è¿‘3ä¸ªæœˆ
            </view>
            <view class="export-option-btn {{dateRange === 'all' ? 'active' : ''}}" bindtap="selectDateRange" data-range="all">
              å…¨éƒ¨
            </view>
          </view>
        </view>
      </view>
      
      <view class="export-options-footer">
        <button class="export-cancel-btn" bindtap="hideExportOptions">å–æ¶ˆ</button>
        <button class="export-confirm-btn" bindtap="exportWeightReport">å¯¼å‡º</button>
      </view>
    </view>
  </view>
  
  <!-- å‡é‡æ•°æ®åˆ†ææ¨¡æ€æ¡† -->
  <view class="modal-mask" wx:if="{{showWeightAnalysisModal}}" bindtap="hideWeightAnalysis">
    <view class="modal-content analysis-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">å‡é‡æ•°æ®åˆ†æ</text>
        <view class="modal-close" bindtap="hideWeightAnalysis">Ã—</view>
      </view>
      
      <scroll-view scroll-y class="modal-body">
        <!-- æ€»ä½“å‡é‡æƒ…å†µ -->
        <view class="analysis-section">
          <view class="analysis-title">æ€»ä½“å‡é‡æƒ…å†µ</view>
          <view class="analysis-cards">
            <view class="analysis-card">
              <text class="analysis-value">{{weightAnalysis.totalLoss}}kg</text>
              <text class="analysis-label">æ€»å‡é‡</text>
            </view>
            <view class="analysis-card">
              <text class="analysis-value">{{weightAnalysis.totalDays}}å¤©</text>
              <text class="analysis-label">æ€»æ—¶é•¿</text>
            </view>
            <view class="analysis-card">
              <text class="analysis-value">{{weightAnalysis.weeklyAvgLoss}}kg</text>
              <text class="analysis-label">å‘¨å¹³å‡</text>
            </view>
          </view>
        </view>
        
        <!-- æœ€ä½³å‡é‡æœŸ -->
        <view class="analysis-section" wx:if="{{weightAnalysis.bestPeriod}}">
          <view class="analysis-title">æœ€ä½³å‡é‡æœŸ</view>
          <view class="best-period">
            <view class="best-period-dates">
              <text>{{weightAnalysis.bestPeriod.startDate}} è‡³ {{weightAnalysis.bestPeriod.endDate}}</text>
              <text class="best-period-days">({{weightAnalysis.bestPeriod.days}}å¤©)</text>
            </view>
            <view class="best-period-stats">
              <text>å‡é‡: {{weightAnalysis.bestPeriod.loss}}kg</text>
              <text>æ—¥å‡: {{weightAnalysis.bestPeriod.dailyRate}}kg/å¤©</text>
            </view>
          </view>
        </view>
        
        <!-- ç›®æ ‡è¾¾æˆé¢„æµ‹ -->
        <view class="analysis-section" wx:if="{{weightAnalysis.targetReachEstimate}}">
          <view class="analysis-title">ç›®æ ‡è¾¾æˆé¢„æµ‹</view>
          <view class="target-estimate">
            <view class="target-date">
              <text class="target-date-label">é¢„è®¡è¾¾æˆæ—¥æœŸ:</text>
              <text class="target-date-value">{{weightAnalysis.targetReachEstimate.date}}</text>
            </view>
            <view class="target-time">
              <text>è¿˜éœ€çº¦ {{weightAnalysis.targetReachEstimate.weeks}} å‘¨ ({{weightAnalysis.targetReachEstimate.days}} å¤©)</text>
            </view>
          </view>
        </view>
        
        <!-- æœˆåº¦å‡é‡è¿›åº¦ -->
        <view class="analysis-section" wx:if="{{weightAnalysis.monthlyData.length > 0}}">
          <view class="analysis-title">æœˆåº¦å‡é‡è¿›åº¦</view>
          <view class="monthly-progress">
            <view class="monthly-item" wx:for="{{weightAnalysis.monthlyData}}" wx:key="month">
              <text class="monthly-month">{{item.month}}</text>
              <view class="monthly-bar-container">
                <view class="monthly-bar" style="width: {{item.loss > 0 ? (item.loss * 20) : 0}}%"></view>
              </view>
              <text class="monthly-value {{item.loss > 0 ? 'positive' : (item.loss < 0 ? 'negative' : '')}}">
                {{item.loss > 0 ? '-' : ''}}{{item.loss}}kg
              </text>
            </view>
          </view>
        </view>
        
        <!-- BMIå˜åŒ–è¶‹åŠ¿ -->
        <view class="analysis-section" wx:if="{{weightAnalysis.bmiTrend}}">
          <view class="analysis-title">BMIå˜åŒ–è¶‹åŠ¿</view>
          <view class="bmi-trend">
            <view class="bmi-trend-values">
              <view class="bmi-trend-item">
                <text class="bmi-trend-label">åˆå§‹BMI:</text>
                <text class="bmi-trend-value">{{weightAnalysis.bmiTrend.initial}}</text>
                <text class="bmi-trend-category">({{weightAnalysis.bmiTrend.initialCategory}})</text>
              </view>
              <view class="bmi-trend-arrow">â†’</view>
              <view class="bmi-trend-item">
                <text class="bmi-trend-label">å½“å‰BMI:</text>
                <text class="bmi-trend-value">{{weightAnalysis.bmiTrend.current}}</text>
                <text class="bmi-trend-category">({{weightAnalysis.bmiTrend.currentCategory}})</text>
              </view>
            </view>
            <view class="bmi-trend-change {{weightAnalysis.bmiTrend.change < 0 ? 'positive' : (weightAnalysis.bmiTrend.change > 0 ? 'negative' : '')}}">
              <text>å˜åŒ–: {{weightAnalysis.bmiTrend.change < 0 ? '' : '+'}}{{weightAnalysis.bmiTrend.change}}</text>
              <text class="bmi-trend-status" wx:if="{{weightAnalysis.bmiTrend.improved}}">ï¼ˆæ”¹å–„ï¼‰</text>
            </view>
          </view>
        </view>
        
        <view class="analysis-tips">
          <text class="analysis-tips-title">å¥åº·æç¤º</text>
          <text class="analysis-tip-item">â€¢ å¥åº·å‡é‡é€Ÿåº¦åº”æ§åˆ¶åœ¨æ¯å‘¨0.5-1å…¬æ–¤</text>
          <text class="analysis-tip-item">â€¢ å¿«é€Ÿå‡é‡å¯èƒ½å¯¼è‡´åå¼¹ï¼Œå»ºè®®ä¿æŒç¨³å®šå‡é‡èŠ‚å¥</text>
          <text class="analysis-tip-item">â€¢ ç»“åˆé¥®é£Ÿæ§åˆ¶å’Œé€‚é‡è¿åŠ¨æ•ˆæœæœ€ä½³</text>
        </view>
      </scroll-view>
      
      <view class="modal-footer">
        <button class="modal-btn" bindtap="hideWeightAnalysis">å…³é—­</button>
      </view>
    </view>
  </view>
  
  <!-- åŠ è½½ä¸­ -->
  <view class="loading-mask" wx:if="{{isLoading || isExporting}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{isExporting ? 'ç”ŸæˆæŠ¥è¡¨ä¸­...' : 'åŠ è½½ä¸­...'}}</text>
  </view>

  <!-- æ‚¬æµ®æŒ‰é’®åŒºåŸŸ -->
  <view class="floating-buttons">
    <view class="floating-button weight-button" bindtap="addWeightRecord">
      <text class="button-icon">âš–ï¸</text>
      <text class="button-text">è®°å½•ä½“é‡</text>
    </view>
    <view class="floating-button product-button" bindtap="addProductUsage">
      <text class="button-icon">ğŸ“‹</text>
      <text class="button-text">è®°å½•äº§å“</text>
    </view>
  </view>
  
  <!-- ä½“é‡è®°å½•å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showWeightModal}}" bindtap="closeWeightModal">
    <view class="modal-content weight-record-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">è®°å½•ä½“é‡</text>
        <view class="modal-close" bindtap="closeWeightModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <!-- æ—©æ™šç§°åˆ‡æ¢ -->
        <view class="time-type-selector">
          <view class="time-type-option {{weightTimeType === 'morning' ? 'active' : ''}}" 
                bindtap="changeWeightTimeType" data-type="morning">
            æ—©ç§°
          </view>
          <view class="time-type-option {{weightTimeType === 'evening' ? 'active' : ''}}" 
                bindtap="changeWeightTimeType" data-type="evening">
            æ™šç§°
          </view>
        </view>
        
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">æ—¥æœŸ</text>
          <picker mode="date" value="{{weightDate}}" bindchange="onWeightDateChange">
            <view class="form-picker">
              <text>{{weightDate}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <!-- ä½“é‡è¾“å…¥ -->
        <view class="form-item">
          <text class="form-label">ä½“é‡(kg)</text>
          <input class="form-input" type="digit" value="{{weightValue}}" 
                 placeholder="è¯·è¾“å…¥ä½“é‡" bindinput="onWeightValueInput" />
        </view>
        
        <!-- æ˜¾ç¤ºæ‰ç§¤é‡æˆ–ä»£è°¢é‡ -->
        <view class="weight-calc-results" wx:if="{{weightValue}}">
          <view class="calc-item" wx:if="{{weightTimeType === 'morning' && weightDropValue !== null}}">
            <text class="calc-label">æ‰ç§¤é‡:</text>
            <text class="calc-value {{weightDropValue > 0 ? 'positive' : (weightDropValue < 0 ? 'negative' : '')}}">
              {{weightDropValue > 0 ? '+' : ''}}{{weightDropValue}} kg
            </text>
          </view>
          <view class="calc-item" wx:if="{{weightTimeType === 'evening' && metabolismValue !== null}}">
            <text class="calc-label">ä»£è°¢é‡:</text>
            <text class="calc-value {{metabolismValue > 0 ? 'positive' : (metabolismValue < 0 ? 'negative' : '')}}">
              {{metabolismValue > 0 ? '+' : ''}}{{metabolismValue}} kg
            </text>
          </view>
          <view class="calc-tip" wx:if="{{(weightTimeType === 'morning' && weightDropValue === null) || (weightTimeType === 'evening' && metabolismValue === null)}}">
            æ— æ³•è®¡ç®—ï¼Œå‰ä¸€å¤©æ²¡æœ‰ç›¸åº”çš„ä½“é‡è®°å½•
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeWeightModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveWeightRecord">ä¿å­˜</button>
      </view>
    </view>
  </view>
  
  <!-- äº§å“ä½¿ç”¨è®°å½•å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showProductModal}}" bindtap="closeProductModal">
    <view class="modal-content product-usage-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{modalTitle || 'è®°å½•äº§å“è´­ä¹°'}}</text>
        <view class="modal-close" bindtap="closeProductModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">ä½¿ç”¨æ—¥æœŸ</text>
          <picker mode="date" value="{{productDate}}" bindchange="onProductDateChange">
            <view class="form-picker">
              <text>{{productDate}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <!-- äº§å“é€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">äº§å“åç§°</text>
          <picker range="{{productList}}" range-key="name" bindchange="onProductSelect">
            <view class="form-picker">
              <text>{{productName || 'è¯·é€‰æ‹©äº§å“'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <!-- ä½¿ç”¨æ¬¡æ•°è¾“å…¥ -->
        <view class="form-item">
          <text class="form-label">å‰©ä½™æ¬¡æ•°</text>
          <input class="form-input" type="number" value="{{quantity}}" 
                 placeholder="è¯·è¾“å…¥å‰©ä½™æ¬¡æ•°" bindinput="onQuantityInput" />
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeProductModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveProductUsage">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view> 