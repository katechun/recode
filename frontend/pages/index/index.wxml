<!--index.wxml-->
<scroll-view class="scrollarea" scroll-y type="list" refresher-enabled="{{true}}" 
             refresher-triggered="{{isRefreshing}}" bindrefresherrefresh="onPullRefresh">
  <view class="container">
    <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯å’Œè®¾ç½®åŒºåŸŸ -->
    <view class="top-section">
      <view class="user-info-card">
        <image class="avatar" src="{{userInfo.avatar || 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'}}"></image>
        <view class="user-basic-info">
          <text class="nickname">{{userInfo.nickname || userInfo.username}}</text>
          <text class="role">{{isAdmin ? 'ç®¡ç†å‘˜' : 'åº—å‘˜'}}</text>
        </view>
      </view>
      
      <!-- ä¿®æ”¹ä¸ºæŒ‰é’®å½¢å¼ -->
      <view class="default-settings-btn" bindtap="showDefaultSettings">
        <text class="settings-btn-text">è®°è´¦é»˜è®¤</text>
        <text class="settings-btn-icon">âš™ï¸</text>
      </view>
    </view>
    
    <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
    <view class="header">
      <view class="filter-bar">
        <picker mode="selector" range="{{dateOptions}}" bindchange="bindDateRangeChange">
          <view class="date-range">
            <text>{{dateRange}}</text>
            <view class="dropdown-icon"></view>
          </view>
        </picker>
        
        <view class="store-selector" bindtap="showStorePicker">
          <text>{{selectedStoreName || 'å…¨éƒ¨åº—é“º'}}</text>
          <view class="dropdown-icon"></view>
        </view>
      </view>
      
      <view class="stats-card">
        <view class="stats-item">
          <text class="stats-label">æ”¶å…¥</text>
          <text class="stats-value income">{{totalIncome}}</text>
        </view>
        <view class="stats-item">
          <text class="stats-label">æ”¯å‡º</text>
          <text class="stats-value expense">{{totalExpense}}</text>
        </view>
        <view class="stats-item">
          <text class="stats-label">ç»“ä½™</text>
          <text class="stats-value {{netAmount >= 0 ? 'income' : 'expense'}}">{{netAmount}}</text>
        </view>
      </view>
    </view>
    
    <!-- ä»Šæ—¥æ•°æ®æ¦‚è§ˆ -->
    <view class="data-overview card">
      <view class="card-title">ä»Šæ—¥æ•°æ®</view>
      <view class="overview-content">
        <view class="overview-item">
          <text class="overview-label">æ”¶å…¥</text>
          <text class="overview-value income">Â¥{{todayData.income}}</text>
        </view>
        <view class="overview-item">
          <text class="overview-label">æ”¯å‡º</text>
          <text class="overview-value expense">Â¥{{todayData.expense}}</text>
        </view>
        <view class="overview-item">
          <text class="overview-label">å‡€é¢</text>
          <text class="overview-value {{todayData.net < 0 ? 'expense' : 'income'}}">Â¥{{todayData.net}}</text>
        </view>
      </view>
    </view>
    
    <!-- æœ€è¿‘è´¦ç›® -->
    <view class="recent-accounts card">
      <view class="card-header">
        <text class="card-title">æœ€è¿‘è´¦ç›®</text>
        <view class="actions-container">
          <view class="view-more" bindtap="navigateToAccountList">æŸ¥çœ‹æ›´å¤š</view>
          <view class="quick-account-btns">
            <view class="quick-btn income" bindtap="goToAddAccount" data-type="income">
              <text class="quick-btn-icon">+</text>
              <text class="quick-btn-text">æ”¶å…¥</text>
            </view>
            <view class="quick-btn expense" bindtap="goToAddAccount" data-type="expense">
              <text class="quick-btn-icon">-</text>
              <text class="quick-btn-text">æ”¯å‡º</text>
            </view>
          </view>
        </view>
      </view>
      <view class="account-list">
        <block wx:if="{{recentAccounts.length > 0}}">
          <view class="account-item {{item.amount < 0 ? 'expense' : ''}}" 
                wx:for="{{recentAccounts}}" 
                wx:key="id" 
                bindtap="viewAccountDetail" 
                data-id="{{item.id}}">
            <view class="account-left">
              <view class="account-info">
                <text class="account-type">{{item.type_name || 'æœªåˆ†ç±»'}}</text>
                <text class="account-store">{{item.store_name || 'æœªçŸ¥åº—é“º'}}</text>
              </view>
              <view class="account-detail">
                <text class="account-time">{{item.create_time}}</text>
                <text class="account-remark" wx:if="{{item.remark}}">{{item.remark}}</text>
              </view>
            </view>
            <view class="account-right">
              <text class="account-amount {{item.amount >= 0 ? 'income' : 'expense'}}">
                {{item.amount >= 0 ? '+' : ''}}{{item.amount}}
              </text>
            </view>
          </view>
        </block>
        <view class="empty-state" wx:if="{{recentAccounts.length === 0 && !isLoading}}">
          <view class="empty-icon">
            <text class="iconfont icon-empty"></text>
          </view>
          <text class="empty-text">æš‚æ— è´¦ç›®æ•°æ®</text>
          <view class="empty-action" bindtap="goToAddAccount" data-type="expense">
            <text>å»è®°ä¸€ç¬”</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ç®¡ç†åŠŸèƒ½åŒºåŸŸç§»åŠ¨åˆ°æœ€è¿‘è´¦ç›®ä¸‹é¢ -->
    <block wx:if="{{isAdmin}}">
      <view class="admin-functions">
        <view class="section-title">ç®¡ç†åŠŸèƒ½</view>
        <view class="function-list">
          <view class="function-item" bindtap="goToStoreManage">
            <text class="function-icon">ğŸª</text>
            <text class="function-text">åº—é“ºç®¡ç†</text>
          </view>
          <view class="function-item" bindtap="goToUserManage">
            <text class="function-icon">ğŸ‘¤</text>
            <text class="function-text">ç”¨æˆ·ç®¡ç†</text>
          </view>
          <view class="function-item" bindtap="goToAccountType">
            <text class="function-icon">ğŸ“Š</text>
            <text class="function-text">è´¦åŠ¡ç±»å‹</text>
          </view>
        </view>
      </view>
    </block>
    
    <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
    <view class="logout-btn" bindtap="logout">é€€å‡ºç™»å½•</view>
    
    <!-- åº—é“ºé€‰æ‹©å¼¹çª— -->
    <view class="store-picker-mask" wx:if="{{storePickerVisible}}" bindtap="closeStorePicker">
      <view class="store-picker" catchtap="stopPropagation">
        <view class="store-picker-header">
          <text>é€‰æ‹©åº—é“º</text>
          <view class="close-icon" bindtap="closeStorePicker">Ã—</view>
        </view>
        <view class="store-list">
          <view class="store-item {{(selectedStoreId === item.id) ? 'active' : ''}}" 
            wx:for="{{stores || []}}" 
            wx:key="id" 
            data-index="{{index}}" 
            bindtap="selectStore">
            {{item.name || ''}}
          </view>
        </view>
      </view>
    </view>

    <!-- ä¼˜åŒ–è®°è´¦é»˜è®¤è®¾ç½®å¼¹çª— -->
    <view class="settings-modal-mask {{showDefaultSettings ? 'visible' : ''}}" bindtap="closeDefaultSettings">
      <view class="settings-modal-container" catchtap="stopPropagation">
        <view class="settings-modal-header">
          <text class="settings-modal-title">è®°è´¦é»˜è®¤è®¾ç½®</text>
          <view class="settings-modal-close" bindtap="closeDefaultSettings">Ã—</view>
        </view>
        
        <view class="settings-modal-content">
          <view class="settings-modal-item">
            <text class="settings-modal-label">åº—é“ºè®¾ç½®</text>
            <picker mode="selector" 
                    range="{{stores}}" 
                    range-key="name" 
                    value="{{storeIndex}}" 
                    bindchange="bindStoreChange">
              <view class="settings-modal-picker {{!selectedStore ? 'empty' : ''}}">
                <text>{{selectedStore ? selectedStore.name : 'è¯·é€‰æ‹©åº—é“º'}}</text>
                <text class="settings-modal-arrow">â–¼</text>
              </view>
            </picker>
          </view>
          
          <view class="settings-modal-section">
            <text class="settings-modal-label">é»˜è®¤æ”¶å…¥ç±»å‹</text>
            <picker mode="selector" 
                    range="{{incomeTypes || []}}" 
                    range-key="name" 
                    value="{{incomeTypeIndex}}" 
                    bindchange="bindIncomeTypeChange">
              <view class="settings-modal-picker {{!selectedIncomeType ? 'empty' : ''}}">
                <text>{{selectedIncomeType ? selectedIncomeType.name : 'è¯·é€‰æ‹©æ”¶å…¥ç±»å‹'}}</text>
                <text class="settings-modal-arrow">â–¼</text>
              </view>
            </picker>
          </view>
          
          <view class="settings-modal-section">
            <text class="settings-modal-label">é»˜è®¤æ”¯å‡ºç±»å‹</text>
            <picker mode="selector" 
                    range="{{expenseTypes || []}}" 
                    range-key="name" 
                    value="{{expenseTypeIndex}}" 
                    bindchange="bindExpenseTypeChange">
              <view class="settings-modal-picker {{!selectedExpenseType ? 'empty' : ''}}">
                <text>{{selectedExpenseType ? selectedExpenseType.name : 'è¯·é€‰æ‹©æ”¯å‡ºç±»å‹'}}</text>
                <text class="settings-modal-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </view>
        
        <view class="settings-modal-footer">
          <button class="settings-modal-btn cancel" bindtap="closeDefaultSettings">å–æ¶ˆ</button>
          <button class="settings-modal-btn confirm" bindtap="saveDefaultSettings">ä¿å­˜</button>
        </view>
      </view>
    </view>

    <!-- æ·»åŠ åœ¨ç°æœ‰è§†å›¾é€‚å½“ä½ç½® -->
    <view class="loading-container" wx:if="{{isLoading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <view class="error-container" wx:if="{{loadError && !isLoading}}">
      <icon type="warn" size="40"></icon>
      <text class="error-text">{{loadError}}</text>
      <button class="retry-btn" bindtap="refreshData">é‡è¯•</button>
    </view>

    <!-- åº•éƒ¨é€‰é¡¹å¡ -->
  <!--  <view class="tabbar">
      <view class="tab-item {{activeTab === 'home' ? 'active' : ''}}" bindtap="handleTabClick" data-id="home">
        <view class="tab-icon home-icon"></view>
        <text>é¦–é¡µ</text>
      </view>
      
      <view class="tab-item {{activeTab === 'account' ? 'active' : ''}}" bindtap="handleTabClick" data-id="account">
        <view class="tab-icon account-icon"></view>
        <text>è´¦ç›®</text>
      </view>
      
      <view class="tab-item add-tab" bindtap="handleTabClick" data-id="add">
        <view class="add-button">+</view>
      </view>
      
      <view class="tab-item {{activeTab === 'statistics' ? 'active' : ''}}" bindtap="handleTabClick" data-id="statistics">
        <view class="tab-icon stats-icon"></view>
        <text>ç»Ÿè®¡</text>
      </view>
      
      <view class="tab-item {{activeTab === 'mine' ? 'active' : ''}}" bindtap="handleTabClick" data-id="mine">
        <view class="tab-icon mine-icon"></view>
        <text>æˆ‘çš„</text>
      </view>
    </view>
    --!>

    <!-- æ·»åŠ è®°è´¦é€‰é¡¹å¼¹çª— -->
    <!--
    <view class="add-options {{showAddOptions ? 'show' : ''}}">
      <view class="mask" bindtap="hideAddOptions"></view>
      <view class="options-container">
        <view class="option-item income" bindtap="handleAddOptionClick" data-type="income">
          <view class="option-icon">+</view>
          <text>æ”¶å…¥</text>
        </view>
        <view class="option-item expense" bindtap="handleAddOptionClick" data-type="expense">
          <view class="option-icon">-</view>
          <text>æ”¯å‡º</text>
        </view>
      </view>
    </view>
--!>
    <!-- ä¼˜åŒ–è´¦ç›®è¯¦æƒ…å¼¹çª— -->
    <view class="detail-modal" wx:if="{{showDetailModal}}">
      <view class="detail-overlay" bindtap="hideDetail"></view>
      <view class="detail-container">
        <view class="detail-type-indicator {{currentAccount.amount >= 0 ? 'income' : 'expense'}}"></view>
        <view class="detail-header">
          <view class="detail-title">è´¦ç›®è¯¦æƒ…</view>
          <view class="detail-close" bindtap="hideDetail">Ã—</view>
        </view>
        
        <view class="detail-body">
          <view class="detail-row amount-row">
            <text class="detail-label">é‡‘é¢</text>
            <view class="detail-value amount {{currentAccount.isIncome ? 'income' : 'expense'}}">
              <text class="currency">Â¥</text>
              <text>{{currentAccount.isIncome ? '' : '-'}}{{currentAccount.formattedAmount}}</text>
            </view>
          </view>
          
          <view class="detail-row">
            <text class="detail-label">ç±»å‹</text>
            <text class="detail-value">{{currentAccount.type_name || 'æœªåˆ†ç±»'}}</text>
          </view>
          
          <view class="detail-row">
            <text class="detail-label">åº—é“º</text>
            <text class="detail-value">{{currentAccount.store_name || 'æœªçŸ¥åº—é“º'}}</text>
          </view>
          
          <view class="detail-row">
            <text class="detail-label">æ—¶é—´</text>
            <text class="detail-value">{{currentAccount.formattedDate || currentAccount.transaction_time}}</text>
          </view>
          
          <view class="detail-row" wx:if="{{currentAccount.remark}}">
            <text class="detail-label">å¤‡æ³¨</text>
            <text class="detail-value remark">{{currentAccount.remark}}</text>
          </view>
          
          <view class="detail-row">
            <text class="detail-label">è®°å½•äºº</text>
            <text class="detail-value">{{currentAccount.username || 'æœªçŸ¥ç”¨æˆ·'}}</text>
          </view>
        </view>
        
        <view class="detail-footer">
          <button class="detail-btn edit" catchtap="editDetailAccount">
            <text class="detail-btn-icon">âœ</text>
            <text>ç¼–è¾‘</text>
          </button>
          <button class="detail-btn delete" catchtap="deleteDetailAccount">
            <text class="detail-btn-icon">ğŸ—‘</text>
            <text>åˆ é™¤</text>
          </button>
        </view>
      </view>
    </view>

    <!-- ç®¡ç†æ¨¡å— -->
    <view class="section admin-section" wx:if="{{isAdmin}}">
      <view class="section-header">
        <text class="section-title">ç³»ç»Ÿç®¡ç†</text>
      </view>
      <view class="admin-grid">
        <navigator url="/pages/userManage/userManage" class="admin-item">
          <view class="admin-icon user-icon"></view>
          <text>ç”¨æˆ·ç®¡ç†</text>
        </navigator>
        <navigator url="/pages/storeManage/storeManage" class="admin-item">
          <view class="admin-icon store-icon"></view>
          <text>åº—é“ºç®¡ç†</text>
        </navigator>
        <navigator url="/pages/accountType/accountType" class="admin-item">
          <view class="admin-icon type-icon"></view>
          <text>è´¦åŠ¡ç±»å‹</text>
        </navigator>
        <navigator url="/pages/products/index" class="admin-item">
          <view class="admin-icon product-icon"></view>
          <text>äº§å“ç®¡ç†</text>
        </navigator>
      </view>
    </view>
  </view>
</scroll-view>

<!-- åœ¨ä¸»å†…å®¹å¤–å±‚æ·»åŠ æ¡ä»¶æ¸²æŸ“ -->
<view wx:if="{{isFirstLoad}}" class="skeleton-screen">
  <view class="skeleton-header"></view>
  <view class="skeleton-card">
    <view class="skeleton-row"></view>
    <view class="skeleton-row small"></view>
  </view>
  <view class="skeleton-stats">
    <view class="skeleton-stat"></view>
    <view class="skeleton-stat"></view>
  </view>
  <view class="skeleton-list">
    <view class="skeleton-item" wx:for="{{3}}" wx:key="index">
      <view class="skeleton-item-left">
        <view class="skeleton-title"></view>
        <view class="skeleton-subtitle"></view>
      </view>
      <view class="skeleton-item-right">
        <view class="skeleton-amount"></view>
      </view>
    </view>
  </view>
</view>
