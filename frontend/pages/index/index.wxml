<!--index.wxml-->
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯å’Œè®¾ç½®åŒºåŸŸ -->
    <view class="top-section">
      <view class="user-info-card">
        <image class="avatar" src="{{userInfo.avatar || '/static/images/default-avatar.png'}}"></image>
        <view class="user-basic-info">
          <text class="nickname">{{userInfo.nickname || userInfo.username}}</text>
          <text class="role">{{isAdmin ? 'ç®¡ç†å‘˜' : 'åº—å‘˜'}}</text>
        </view>
      </view>
      
      <!-- ä¿®æ”¹ä¸ºæŒ‰é’®å½¢å¼ -->
      <view class="default-settings-btn" bindtap="showDefaultSettings">
        <text class="settings-btn-text">è®°è´¦é»˜è®¤</text>
        <text class="settings-btn-icon">âš™ï¸</text>
      </view>
    </view>
    
    <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
    <view class="header">
      <view class="filter-bar">
        <picker mode="selector" range="{{dateOptions}}" bindchange="bindDateRangeChange">
          <view class="date-range">
            <text>{{dateRange}}</text>
            <view class="dropdown-icon"></view>
          </view>
        </picker>
        
        <view class="store-selector" bindtap="showStorePicker">
          <text>{{selectedStoreName || 'å…¨éƒ¨åº—é“º'}}</text>
          <view class="dropdown-icon"></view>
        </view>
      </view>
      
      <view class="stats-card">
        <view class="stats-item">
          <text class="stats-label">æ”¶å…¥</text>
          <text class="stats-value income">{{totalIncome}}</text>
        </view>
        <view class="stats-item">
          <text class="stats-label">æ”¯å‡º</text>
          <text class="stats-value expense">{{totalExpense}}</text>
        </view>
        <view class="stats-item">
          <text class="stats-label">ç»“ä½™</text>
          <text class="stats-value {{netAmount >= 0 ? 'income' : 'expense'}}">{{netAmount}}</text>
        </view>
      </view>
    </view>
    
    <!-- å¿«æ·è®°è´¦åŒºåŸŸ -->
    <view class="quick-actions-area">
      <view class="section-title">å¿«æ·è®°è´¦</view>
      <view class="quick-actions">
        <view class="quick-action income" bindtap="quickAddAccount" data-type="income" data-store-id="{{selectedStore.id || ''}}" data-type-id="{{selectedIncomeType.id || ''}}">
          <text class="quick-icon">+</text>
          <text>æ”¶å…¥</text>
        </view>
        <view class="quick-action expense" bindtap="quickAddAccount" data-type="expense" data-store-id="{{selectedStore.id || ''}}" data-type-id="{{selectedExpenseType.id || ''}}">
          <text class="quick-icon">-</text>
          <text>æ”¯å‡º</text>
        </view>
      </view>
    </view>
    
    <!-- ä»Šæ—¥æ•°æ®æ¦‚è§ˆ -->
    <view class="data-overview card">
      <view class="card-title">ä»Šæ—¥æ•°æ®</view>
      <view class="overview-content">
        <view class="overview-item">
          <text class="overview-label">æ”¶å…¥</text>
          <text class="overview-value income">Â¥{{todayIncome}}</text>
        </view>
        <view class="overview-item">
          <text class="overview-label">æ”¯å‡º</text>
          <text class="overview-value expense">Â¥{{todayExpense}}</text>
        </view>
      </view>
    </view>
    
    <!-- æœ€è¿‘è´¦ç›® -->
    <view class="recent-accounts card">
      <view class="card-header">
        <text class="card-title">æœ€è¿‘è´¦ç›®</text>
        <view class="view-all" bindtap="navigateToAccount">æŸ¥çœ‹å…¨éƒ¨</view>
      </view>
      <view class="account-list">
        <block wx:if="{{recentAccounts.length > 0}}">
          <view wx:for="{{recentAccounts}}" wx:key="id" class="account-item">
            <view class="account-info">
              <text class="account-store">{{item.store_name}}</text>
              <text class="account-type">{{item.type_name}}</text>
            </view>
            <view class="account-detail">
              <text class="account-amount {{item.amount >= 0 ? 'income' : 'expense'}}">{{item.amount >= 0 ? '+' : ''}}{{item.amount}}</text>
              <text class="account-time">{{item.create_time}}</text>
            </view>
          </view>
        </block>
        <view wx:else class="no-data">æš‚æ— è´¦ç›®æ•°æ®</view>
      </view>
    </view>
    
    <!-- ç®¡ç†åŠŸèƒ½åŒºåŸŸç§»åŠ¨åˆ°æœ€è¿‘è´¦ç›®ä¸‹é¢ -->
    <block wx:if="{{isAdmin}}">
      <view class="admin-functions">
        <view class="section-title">ç®¡ç†åŠŸèƒ½</view>
        <view class="function-list">
          <view class="function-item" bindtap="goToStoreManage">
            <text class="function-icon">ğŸª</text>
            <text class="function-text">åº—é“ºç®¡ç†</text>
          </view>
          <view class="function-item" bindtap="goToUserManage">
            <text class="function-icon">ğŸ‘¤</text>
            <text class="function-text">ç”¨æˆ·ç®¡ç†</text>
          </view>
          <view class="function-item" bindtap="goToAccountType">
            <text class="function-icon">ğŸ“Š</text>
            <text class="function-text">è´¦åŠ¡ç±»å‹</text>
          </view>
        </view>
      </view>
    </block>
    
    <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
    <view class="logout-btn" bindtap="logout">é€€å‡ºç™»å½•</view>
    
    <!-- åº—é“ºé€‰æ‹©å¼¹çª— -->
    <view class="store-picker-mask" wx:if="{{storePickerVisible}}" bindtap="closeStorePicker">
      <view class="store-picker" catchtap="stopPropagation">
        <view class="store-picker-header">
          <text>é€‰æ‹©åº—é“º</text>
          <view class="close-icon" bindtap="closeStorePicker">Ã—</view>
        </view>
        <view class="store-list">
          <view class="store-item {{(selectedStoreId === item.id) ? 'active' : ''}}" 
            wx:for="{{stores || []}}" 
            wx:key="id" 
            data-index="{{index}}" 
            bindtap="selectStore">
            {{item.name || ''}}
          </view>
        </view>
      </view>
    </view>

    <!-- æ·»åŠ è®°è´¦é»˜è®¤å¼¹çª— -->
    <view class="settings-mask" wx:if="{{defaultSettingsVisible}}" bindtap="closeDefaultSettings">
      <view class="settings-modal" catchtap="stopPropagation">
        <view class="settings-header">
          <text class="settings-title">è®°è´¦é»˜è®¤è®¾ç½®</text>
          <view class="close-icon" bindtap="closeDefaultSettings">Ã—</view>
        </view>
        <view class="settings-content">
          <!-- åº—é“ºé€‰æ‹© -->
          <view class="settings-item">
            <text class="settings-label">åº—é“º:</text>
            <picker mode="selector" range="{{stores}}" range-key="name" value="{{storeIndex}}" bindchange="bindStoreChange">
              <view class="settings-picker">
                {{selectedStore ? selectedStore.name : 'è¯·é€‰æ‹©åº—é“º'}}
              </view>
            </picker>
          </view>
          
          <!-- æ”¶å…¥ç±»å‹é€‰æ‹© -->
          <view class="settings-item">
            <text class="settings-label">æ”¶å…¥ç±»å‹:</text>
            <picker mode="selector" range="{{incomeTypes}}" range-key="name" value="{{incomeTypeIndex}}" bindchange="bindIncomeTypeChange">
              <view class="settings-picker">
                {{selectedIncomeType ? selectedIncomeType.name : 'è¯·é€‰æ‹©æ”¶å…¥ç±»å‹'}}
              </view>
            </picker>
          </view>
          
          <!-- æ”¯å‡ºç±»å‹é€‰æ‹© -->
          <view class="settings-item">
            <text class="settings-label">æ”¯å‡ºç±»å‹:</text>
            <picker mode="selector" range="{{expenseTypes}}" range-key="name" value="{{expenseTypeIndex}}" bindchange="bindExpenseTypeChange">
              <view class="settings-picker">
                {{selectedExpenseType ? selectedExpenseType.name : 'è¯·é€‰æ‹©æ”¯å‡ºç±»å‹'}}
              </view>
            </picker>
          </view>
          
          <view class="btn-container">
            <button class="save-btn" bindtap="closeDefaultSettings">ç¡®å®š</button>
          </view>
        </view>
      </view>
    </view>
  </view>
</scroll-view>
